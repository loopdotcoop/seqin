"use strict";!function(){var t=window.SEQIN=window.SEQIN||{};t.NAME="seqin",t.VERSION="0.0.12",
t.HOMEPAGE="http://seqin.loop.coop/";var i,e,s;t.Main=$traceurRuntime.createClass(function(r){
var o=this;i=t.Slot,e=t.TrackSlot,s=t.MasterSlot,this.worker=r.worker,this.fidelity=r.fidelity||5400,
this.notes=[],this.cbs={"*":[]},this.metronome="o",this.droppedTicks=0,this.duplicateTicks=0,
this.missedTicks=0,this.ctx=new(window.AudioContext||window.webkitAudioContext),
this.tracks=[];for(var u=0;u<(r.tracks||1);u++)this.tracks.push(new a(u,this));
this.masterChannel=new c(this),this.steps=[];for(var h=0;h<(r.steps||16);h++)this.steps.push(new n(h,this));
this.isPlaying=!0,this.activeStep=this.steps[0],this.activeStep.isActive=!0,this.play(),
setTimeout(function(){o.worker.postMessage({action:"sync",value:1e3*o.ctx.currentTime
})},1e3),this.worker.onmessage=function(t){var i=t.data,e=i.action,s=i.notice,n=(i.now,
i.tickId,i.dropped),r=i.duplicate;"tick"===e&&(o.droppedTicks=n,o.duplicateTicks=r,
o.scheduleTick(s))}},{scheduleTick:function(t){var i=this,e=this.ctx.currentTime,s=e%.12244897959183673,n=.12244897959183673-s;
if(this.isPlaying){var r=this.ctx.createBufferSource(),a=(this.activeStep.id+1)%this.steps.length,c=this.steps[a],o=e+n;
r.buffer=c.masterSlot.buffer,r.connect(this.ctx.destination),0>n?(this.missedTicks++,
r.start(0,-n)):r.start(o)}setTimeout(function(){return i.tick()},t+30);
},tick:function(){this.metronome="o"===this.metronome?"x":"o",this.isPlaying&&this.seek(this.activeStep.id+1),
this.trigger("tick")},on:function(t,i){var e=this.cbs[t];e&&e.push(i);
},trigger:function(t){if(this.cbs[t])for(var i=0,e=void 0;e=this.cbs[t][i++];)e(t);
for(var s=0,n=void 0;n=this.cbs["*"][s++];)n(t)},play:function(){
this.isPlaying||(this.isPlaying=!0,this.trigger("play"))},stop:function(){
this.isPlaying&&(this.isPlaying=!1,this.trigger("stop"))},seek:function(t){
this.activeStep.isActive=!1,this.activeStep=this.steps[t%this.steps.length],this.activeStep.isActive=!0,
this.trigger("seek")},addNote:function(t){return t.id=this.notes.length,this.notes.push(new o(t,this)),
this.trigger("add-note"),t.id},dump:function(){for(var t=["["+this.metronome+"] "+this.ctx.sampleRate/1e3+"kHz\n"+("    dropped ticks: "+this.droppedTicks+"\n")+("    duplicate ticks: "+this.duplicateTicks+"\n")+("    missed ticks: "+this.missedTicks)],i=0,e=void 0;e=this.steps[i++];)t.push(e.dump());
return t.join("\n")}},{});var n=function(){function t(t,i){this.id=t,this.seqin=i,
this.isActive=!1,this.trackSlots=[];for(var n=0,r=void 0;r=i.tracks[n++];)this.trackSlots.push(new e(i,r));
this.masterSlot=new s(i,i.masterChannel,this.trackSlots)}return $traceurRuntime.createClass(t,{
dump:function(){var t=[],i=(this.seqin.steps.length+"").length,e=(this.id+"").length;
t.push(this.isActive?this.seqin.isPlaying?">":"#":"."),t.push(" ".repeat(i-e)),t.push(this.id);
for(var s=0,n=void 0;n=this.trackSlots[s++];)t.push("|"+n.dump()+"|");
return t.push("|"+this.masterSlot.dump()+"|"),t.join("")}},{})}(),r=function(){
function t(t){this.seqin=t,this.max=0}return $traceurRuntime.createClass(t,{},{});
}(),a=function(t){function i(t,e){$traceurRuntime.superConstructor(i).call(this,e),
this.id=t,this.notes={}}return $traceurRuntime.createClass(i,{addNote:function(t){
this.notes[t.id]=t,this.updateMax()},updateMax:function(){var t=this;
this.seqin.steps.forEach(function(i){return i.trackSlots.forEach(function(i){
return t.max=Math.max(t.max,i.text.length)})})}},{},t)}(r),c=function(t){
function i(t){$traceurRuntime.superConstructor(i).call(this,t)}return $traceurRuntime.createClass(i,{
updateMax:function(){var t=this;this.seqin.steps.forEach(function(i){
return t.max=Math.max(t.max,i.masterSlot.text.length)})}},{},t)}(r),o=function(){
function t(t,i){for(var e in t)this[e]=t[e];this.voice.updateSteps(t,i),i.tracks[this.track].addNote(this);
}return $traceurRuntime.createClass(t,{},{})}()}(),!function(){var t=window.SEQIN=window.SEQIN||{},i=[""," ","  ","   ","    ","     ","      ","       "];
t.Slot=$traceurRuntime.createClass(function(t,i){this.track=i,this.buffer=t.ctx.createBuffer(1,t.fidelity,t.ctx.sampleRate);
},{},{}),t.TrackSlot=function(t){function e(t,i){$traceurRuntime.superConstructor(e).call(this,t,i),
this.note=null,this.adsr=null,this.text=""}return $traceurRuntime.createClass(e,{
dump:function(){return this.text+i[this.track.max-this.text.length];
}},{},t)}(t.Slot),t.MasterSlot=function(t){function e(t,i,s){$traceurRuntime.superConstructor(e).call(this,t,i),
this.seqin=t,this.isMixing=!1,this.trackSlots=s,this.text=""}return $traceurRuntime.createClass(e,{
mix:function(){var t=this;this.isMixing=!0;for(var i=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,this.seqin.fidelity,this.seqin.ctx.sampleRate),e=0,s=void 0;s=this.trackSlots[e++];)if(""!==s.text){
var n=i.createBufferSource();n.buffer=s.buffer,n.connect(i.destination),n.start();
}i.startRendering(),i.oncomplete=function(i){t.buffer=i.renderedBuffer,t.isMixing=!1;
for(var e=[],s=0,n=void 0;n=t.trackSlots[s++];)""!==n.text&&e.push(n.text);
t.text=e.join("+"),t.seqin.masterChannel.updateMax()}},dump:function(){
return this.isMixing?"!".repeat(this.text.length):this.text+i[this.track.max-this.text.length];
}},{},t)}(t.Slot)}(),!function(){var t=window.SEQIN=window.SEQIN||{};
t.Voice=$traceurRuntime.createClass(function(){},{},{updateSteps:function(t,i){
var e=t.on,s=i.steps[e],n=s.trackSlots[t.track],r=n.buffer.getChannelData(0);
r[0]=t.velocity,r[1]=.5*t.velocity,n.text=.5<=t.velocity?"* ":"Â· ",s.masterSlot.mix();
}}),t.Buzz=function(t){function i(){$traceurRuntime.superConstructor(i).apply(this,arguments);
}return $traceurRuntime.createClass(i,{},{updateSteps:function(t,i){
for(var e=t.on,s=i.steps.length,n=2*Math.PI*t.cycles/i.fidelity,r=0,a=void 0,c=void 0,o=void 0;r<t.duration;r++){
a=i.steps[e++%s],c=a.trackSlots[t.track],o=c.buffer.getChannelData(0);
for(var u=0;u<5400;u++)o[u]=Math.sin(u*n)/2;c.text=t.cycles+"",a.masterSlot.mix(a.trackSlots.filter(function(t){
return t.note}))}}},t)}(t.Voice),t.Noise=function(t){function i(){
$traceurRuntime.superConstructor(i).apply(this,arguments)}return $traceurRuntime.createClass(i,{},{},t);
}(t.Voice)}();