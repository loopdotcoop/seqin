"use strict";!function(){var t=window.SEQIN=window.SEQIN||{};t.NAME="seqin",t.VERSION="0.0.11",
t.HOMEPAGE="http://seqin.loop.coop/";var i,s,e;t.Main=$traceurRuntime.createClass(function(o){
var c=this;i=t.Slot,s=t.TrackSlot,e=t.MasterSlot,this.worker=o.worker,this.fidelity=o.fidelity||5600,
this.notes=[],this.cbs={"*":[]},this.metronome="o",this.droppedTicks=0,this.duplicateTicks=0,
this.missedTicks=0,this.ctx=new(window.AudioContext||window.webkitAudioContext),
this.tracks=[];for(var a=0;a<(o.tracks||1);a++)this.tracks.push(new r(a,this));
this.steps=[];for(var h=0;h<(o.steps||16);h++)this.steps.push(new n(h,this));
this.isPlaying=!0,this.activeStep=this.steps[0],this.activeStep.isActive=!0,this.play(),
setTimeout(function(){c.worker.postMessage({action:"sync",value:1e3*c.ctx.currentTime
})},1e3),this.worker.onmessage=function(t){var i=t.data,s=i.action,e=i.notice,n=(i.now,
i.tickId,i.dropped),r=i.duplicate;"tick"===s&&(c.droppedTicks=n,c.duplicateTicks=r,
c.scheduleTick(e))}},{scheduleTick:function(t){var i=this,s=this.ctx.currentTime,e=s%.12244897959183673,n=.12244897959183673-e;
if(this.isPlaying){var r=this.ctx.createBufferSource(),o=(this.activeStep.id+1)%this.steps.length,c=this.steps[o],a=s+n;
r.buffer=c.masterSlot.buffer,r.connect(this.ctx.destination),0>n?(this.missedTicks++,
r.start(0,-n)):r.start(a)}setTimeout(function(){return i.tick()},t+30);
},tick:function(){this.metronome="o"===this.metronome?"x":"o",this.isPlaying&&this.seek(this.activeStep.id+1),
this.trigger("tick")},on:function(t,i){var s=this.cbs[t];s&&s.push(i);
},trigger:function(t){if(this.cbs[t])for(var i=0,s=void 0;s=this.cbs[t][i++];)s(t);
for(var e=0,n=void 0;n=this.cbs["*"][e++];)n(t)},play:function(){
this.isPlaying||(this.isPlaying=!0,this.trigger("play"))},stop:function(){
this.isPlaying&&(this.isPlaying=!1,this.trigger("stop"))},seek:function(t){
this.activeStep.isActive=!1,this.activeStep=this.steps[t%this.steps.length],this.activeStep.isActive=!0,
this.trigger("seek")},addNote:function(t){return t.id=this.notes.length,this.notes.push(new o(t,this)),
this.trigger("add-note"),t.id},dump:function(){for(var t=["["+this.metronome+"] "+this.ctx.sampleRate/1e3+"kHz\n"+("    dropped ticks: "+this.droppedTicks+"\n")+("    duplicate ticks: "+this.duplicateTicks+"\n")+("    missed ticks: "+this.missedTicks)],i=0,s=void 0;s=this.steps[i++];)t.push(s.dump());
return t.join("\n")}},{});var n=function(){function t(t,i){this.id=t,this.seqin=i,
this.isActive=!1,this.trackSlots=[];for(var n=0;n<i.tracks.length;n++)this.trackSlots.push(new s(i));
this.masterSlot=new e(i)}return $traceurRuntime.createClass(t,{addNote:function(t,i){
this.trackSlots[t.track].update(t,i),this.masterSlot.mix(this.trackSlots.filter(function(t){
return t.note}))},dump:function(){var t=[],i=(this.seqin.steps.length+"").length,s=(this.id+"").length;
t.push(this.isActive?this.seqin.isPlaying?">":"#":"."),t.push(" ".repeat(i-s)),t.push(this.id);
for(var e=0,n=void 0;n=this.trackSlots[e++];)t.push("| "+n.dump()+" |");
return t.push(this.masterSlot.dump()),t.join(" ")}},{})}(),r=function(){
function t(t,i){this.id=t,this.seqin=i,this.notes={}}return $traceurRuntime.createClass(t,{
addNote:function(t){this.notes[t.id]=t}},{})}(),o=function(){function t(t,i){
for(var s in t)this[s]=t[s];i.tracks[this.track].addNote(this);var e=this.on,n=i.steps.length;
i.steps[e%n].addNote(this,"attack"),i.steps[++e%n].addNote(this,"decay");
for(var r=0;r<this.duration;r++)i.steps[++e%n].addNote(this,"sustain");
for(var o=0;o<this.voice.release;o++)i.steps[++e%n].addNote(this,"release");
}return $traceurRuntime.createClass(t,{},{})}()}(),!function(){var t=window.SEQIN=window.SEQIN||{};
t.Slot=$traceurRuntime.createClass(function(t){this.buffer=t.ctx.createBuffer(1,t.fidelity,t.ctx.sampleRate);
},{},{}),t.TrackSlot=function(t){function i(t){$traceurRuntime.superConstructor(i).call(this,t),
this.note=null,this.adsr=null}return $traceurRuntime.createClass(i,{
update:function(t,i){this.note=t,this.adsr=i,t.voice.fillBuffer({
buffer:this.buffer.getChannelData(0),adsr:i,pitch:t.pitch,velocity:t.velocity
})},dump:function(){return"attack"===this.adsr?this.note.pitch.split("").join("̲")+"̲":"decay"===this.adsr?this.note.pitch:"sustain"===this.adsr?this.note.pitch.toLowerCase():"release"===this.adsr?"..":"  ";
}},{},t)}(t.Slot),t.MasterSlot=function(t){function i(t){$traceurRuntime.superConstructor(i).call(this,t),
this.seqin=t,this.isMixing=!1}return $traceurRuntime.createClass(i,{
mix:function(t){var i=this;this.isMixing=!0,this.trackSlots=t;for(var s=new(window.OfflineAudioContext||window.webkitOfflineAudioContext)(1,this.seqin.fidelity,this.seqin.ctx.sampleRate),e=0,n=void 0;n=t[e++];){
var r=s.createBufferSource();r.buffer=n.buffer,r.connect(s.destination),r.start();
}s.startRendering(),s.oncomplete=function(t){i.buffer=t.renderedBuffer,i.isMixing=!1;
}},dump:function(){return this.trackSlots?this.isMixing?"!!!":this.trackSlots.map(function(t){
return t.dump()}).join("+"):" "}},{},t)}(t.Slot)}();